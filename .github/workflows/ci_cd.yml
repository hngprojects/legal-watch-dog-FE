name: Frontend CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:

  # ------------------------
  # 1. BUILD JOB
  # ------------------------
  build:
    name: Build Frontend
    runs-on: [self-hosted]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build

      - name: Archive build output
        run: tar -czf build.tar.gz dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: build.tar.gz


  # -------------------------
  # 2. DEPLOY TO STAGING (DEV BRANCH)
  # -------------------------
  deploy_staging:
    name: CD - Frontend Deploy (Staging)
    runs-on: [self-hosted]
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment: staging

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Set up SSH and Deploy
        env:
          SERVER_PASS: ${{ secrets.STAGING_PASS }}
          SERVER_USER: ${{ secrets.STAGING_USER }}
          SERVER_IP: ${{ secrets.STAGING_IP }}
        run: |
          echo "access gained"
          echo "copying files to server"

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no build.tar.gz $SERVER_USER@$SERVER_IP:/tmp/

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e
              REMOTE_DIR="/home//apps/frontend/legal-watch-dog-FE"
            # Clone if the directory doesn'ifeanyinwt exist
            if [ ! -d "$REMOTE_DIR" ]; then
              cd /home/ifeanyinw/apps/frontend/
              git clone https://github.com/hngprojects/legal-watch-dog-FE.git "$REMOTE_DIR"
            fi


            #cd /home/ifeanyinw/apps/frontend/legal-watch-dog-FE || git clone git@github.com:hngprojects/legal-watch-dog-FE.git
            cd "$REMOTE_DIR"
            # git remote set-url origin git@github.com:hngprojects/legal-watch-dog-FE.git
            git pull origin staging
            rm -rf dist
            tar -xzf /tmp/build.tar.gz -C .
            chmod -R o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE/dist
            chmod o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE
            chmod o+rx /home/ifeanyinw
            chmod o+rx /home/ifeanyinw/apps
            chmod o+rx /home/ifeanyinw/apps/frontend
            sudo nginx -s reload
          EOF


  # ------------------------
  # 3. DEPLOY TO PRODUCTION (MAIN BRANCH)
  # ------------------------
  deploy_production:
    name: CD - Frontend Deploy (Production)
    runs-on: [self-hosted]
    needs: build
    if: github.ref == 'refs/heads/dev'
    environment: production

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Set up SSH and Deploy
        env:
          SERVER_PASS: ${{ secrets.PROD_PASS }}
          SERVER_USER: ${{ secrets.PROD_USER }}
          SERVER_IP: ${{ secrets.PROD_IP }}
        run: |
          echo "access gained"
          echo "copying files to server"

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no build.tar.gz $SERVER_USER@$SERVER_IP:/tmp/

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/frontend/legal-watch-dog-FE"
            # Clone if the directory doesn't exist
            if [ ! -d "$REMOTE_DIR" ]; then
              cd /home/ifeanyinw/apps/frontend/
              git clone https://github.com/hngprojects/legal-watch-dog-FE.git "$REMOTE_DIR"
            fi


            #cd /home/ifeanyinw/apps/frontend/legal-watch-dog-FE || git clone git@github.com:hngprojects/legal-watch-dog-FE.git
            cd "$REMOTE_DIR"
            
            git pull origin dev
            rm -rf dist
            tar -xzf /tmp/build.tar.gz -C .
            chmod -R o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE/dist
            chmod o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE
            chmod o+rx /home/ifeanyinw
            chmod o+rx /home/ifeanyinw/apps
            chmod o+rx /home/ifeanyinw/apps/frontend
            sudo nginx -s reload
          EOF


  # -------------------------
  # 4. Slack Notification
  # -------------------------
  notify_slack:
    name: Notify Slack
    runs-on: [self-hosted]
    needs: 
      - build
      - deploy_staging
      - deploy_production
    if: always()
    steps:
      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          BUILD_RESULT: ${{ needs.build.result }}
          STAGING_RESULT: ${{ needs.deploy_staging.result }}
          PROD_RESULT: ${{ needs.deploy_production.result }}
        run: |
          # Determine overall status
          if [ "$BUILD_RESULT" != "success" ] || [ "$STAGING_RESULT" != "success" ] || [ "$PROD_RESULT" != "success" ]; then
            STATUS="❌ FAILURE"
          else
            STATUS="✅ SUCCESS"
          fi

          LOG_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          PAYLOAD="{
            \"text\": \"Frontend CI/CD Pipeline finished with status: $STATUS\nLogs: $LOG_LINK\",
            \"username\": \"CI/CD Bot\",
            \"icon_emoji\": \":rocket:\"
          }"

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK
