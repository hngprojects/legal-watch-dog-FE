name: Frontend CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - staging
      - dev
  pull_request:
    branches:
      - main
      - staging
      - dev

jobs:
  # ------------------------
  # 1. BUILD JOB
  # ------------------------
  build:
    name: Build Frontend
    runs-on: [self-hosted]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build

      - name: Archive build output
        run: tar -czf build.tar.gz dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: build.tar.gz

  # -------------------------
  # 2. DEPLOY TO STAGING
  # -------------------------
  deploy_staging:
    name: CD - Frontend Deploy (Staging)
    runs-on: [self-hosted]
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment: staging

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Generate staging enviornment file
        run: |
          cat <<EOT > .env
          /// <reference types="vite/client" />
          /// <reference types="lucide-vue-next" />
          interface ImportMetaEnv {
            readonly VITE_USE_MOCK_API?: string
            readonly VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL }}"
          }
          interface ImportMeta {
            readonly env: ImportMetaEnv
          }
          
          EOF
          echo ".env file created successfully."


      - name: Set up SSH and Deploy
        env:
          SERVER_PASS: ${{ secrets.STAGING_PASS }}
          SERVER_USER: ${{ secrets.STAGING_USER }}
          SERVER_IP: ${{ secrets.STAGING_IP }}
        run: |
          echo "access gained"
          echo "copying files to server"

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no build.tar.gz $SERVER_USER@$SERVER_IP:/tmp/

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no .env $SERVER_USER@$SERVER_IP:/tmp/frontend_env

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/frontend/legal-watch-dog-FE-staging"
            BRANCH="staging"
            REPO_URL="https://github.com/hngprojects/legal-watch-dog-FE.git"

            # Clone if the directory doesn't exist
            if [ ! -d "$REMOTE_DIR" ]; then
              cd /home/ifeanyinw/apps/frontend/
              git clone -b "$BRANCH" "$REPO_URL" "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"

            git checkout "$BRANCH"
            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"

            mv /tmp/frontend_env .env || true

            rm -rf dist
            tar -xzf /tmp/build.tar.gz -C .
            chmod -R o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE-staging/dist
            chmod o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE-staging
            chmod o+rx /home/ifeanyinw
            chmod o+rx /home/ifeanyinw/apps
            chmod o+rx /home/ifeanyinw/apps/frontend

            sudo nginx -s reload
          EOF

      - name: Mark Deployment Result
        if: failure()
        run: echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

  # ------------------------
  # 3. DEPLOY TO PRODUCTION (MAIN BRANCH)
  # ------------------------
  deploy_production:
    name: CD - Frontend Deploy (Production)
    runs-on: [self-hosted]
    needs: build
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'staging'
    environment: production

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Generate production environment file
        run: |
          cat <<EOT > .env
          /// <reference types="vite/client" />
          /// <reference types="lucide-vue-next" />
          interface ImportMetaEnv {
            readonly VITE_USE_MOCK_API?: string
            readonly VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL }}"
          }
          interface ImportMeta {
            readonly env: ImportMetaEnv
          }
          
          EOF

      - name: Set up SSH and Deploy
        env:
          SERVER_PASS: ${{ secrets.PROD_PASS }}
          SERVER_USER: ${{ secrets.PROD_USER }}
          SERVER_IP: ${{ secrets.PROD_IP }}
        run: |
          echo "access gained"
          echo "copying files to server"

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no build.tar.gz $SERVER_USER@$SERVER_IP:/tmp/

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no .env $SERVER_USER@$SERVER_IP:/tmp/frontend_env

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/frontend/legal-watch-dog-FE-production"
            BRANCH="main"
            
            # Clone if the directory doesn't exist
            if [ ! -d "$REMOTE_DIR" ]; then
              cd /home/ifeanyinw/apps/frontend/
              git clone https://github.com/hngprojects/legal-watch-dog-FE.git "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"
            
            git checkout "$BRANCH"
            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"

            mv /tmp/frontend_env .env || true

            rm -rf dist
            tar -xzf /tmp/build.tar.gz -C .
            chmod -R o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE-production/dist
            chmod o+rx /home/ifeanyinw/apps/frontend/legal-watch-dog-FE-production
            chmod o+rx /home/ifeanyinw
            chmod o+rx /home/ifeanyinw/apps
            chmod o+rx /home/ifeanyinw/apps/frontend
            
            sudo nginx -s reload
          EOF

      - name: Mark Deployment Result
        if: failure()
        run: echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

  # -------------------------
  # 4. Slack Notification
  # -------------------------
  notify_slack:
    name: Notify Slack
    runs-on: [self-hosted]
    needs:
      - build
      - deploy_staging
      - deploy_production
    if: always()

    steps:
      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          BUILD_RESULT: ${{ needs.build.result }}
          STAGING_RESULT: ${{ needs.deploy_staging.result }}
          PROD_RESULT: ${{ needs.deploy_production.result }}
        run: |
          echo "Preparing Slack message..."

          # Get branch name
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          # Determine high-level outcome and set appropriate emoji
          if [ "$BUILD_RESULT" == "success" ] && ([ "$STAGING_RESULT" == "success" ] || [ "$STAGING_RESULT" == "skipped" ]) && ([ "$PROD_RESULT" == "success" ] || [ "$PROD_RESULT" == "skipped" ]); then
            MAIN_STATUS="‚úÖ Deployment Successful"
            STATUS_COLOR="good"
          else
            MAIN_STATUS="‚ùå Deployment Failed"
            STATUS_COLOR="danger"
          fi

          # Build detailed status for each stage
          DETAIL_MSG=""

          # Build Stage
          if [ "$BUILD_RESULT" == "success" ]; then
            DETAIL_MSG="${DETAIL_MSG}\n‚úÖ *Build:* Application built successfully"
          else
            DETAIL_MSG="${DETAIL_MSG}\n‚ùå *Build:* Failed to build application"
          fi

          # Staging Deploy Stage
          if [ "$STAGING_RESULT" == "success" ]; then
            DETAIL_MSG="${DETAIL_MSG}\n‚úÖ *Test Environment:* Successfully deployed to staging server"
          elif [ "$STAGING_RESULT" == "skipped" ]; then
            DETAIL_MSG="${DETAIL_MSG}\n‚è≠Ô∏è *Test Environment:* Skipped (not a dev branch)"
          else
            DETAIL_MSG="${DETAIL_MSG}\n‚ùå *Test Environment:* Failed to deploy to staging server"
          fi

          # Production Deploy Stage
          if [ "$PROD_RESULT" == "success" ]; then
            DETAIL_MSG="${DETAIL_MSG}\n‚úÖ *Live Website:* Successfully deployed to production server"
          elif [ "$PROD_RESULT" == "skipped" ]; then
            DETAIL_MSG="${DETAIL_MSG}\n‚è≠Ô∏è *Live Website:* Skipped (not main branch)"
          else
            DETAIL_MSG="${DETAIL_MSG}\n‚ùå *Live Website:* Failed to deploy to production server"
          fi

          # Add branch info
          DETAIL_MSG="${DETAIL_MSG}\n\nüìã *Branch:* \`${BRANCH_NAME}\`"
          DETAIL_MSG="${DETAIL_MSG}\nüë§ *Triggered by:* ${GITHUB_ACTOR}"

          LOG_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          # Format Slack JSON with rich formatting
          PAYLOAD="{
            \"attachments\": [
              {
                \"color\": \"${STATUS_COLOR}\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"üöÄ Frontend Deployment Update\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*${MAIN_STATUS}*${DETAIL_MSG}\"
                    }
                  },
                  {
                    \"type\": \"divider\"
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"Need help? Check the <${LOG_LINK}|detailed logs> or contact the development team.\"
                    }
                  }
                ]
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK